./outputs.tf
\n\n# ===== ./outputs.tf =====\n\n
output "queues" {
  value = {
    high   = aws_sqs_queue.high_priority.name
    normal = aws_sqs_queue.normal_priority.name
    low    = aws_sqs_queue.low_priority.name
  }
}
output "api_url" {
  value = aws_apigatewayv2_api.http_api.api_endpoint
}
./locals.tf
\n\n# ===== ./locals.tf =====\n\n
locals { 
    name_prefix = "${var.project_name}-${var.environment}"
}./main.tf
\n\n# ===== ./main.tf =====\n\n
terraform {
  required_version = ">= 1.5.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "> 5.0"
    }
  }
}
provider "aws" {
  region = var.aws_region
}
./frontend.tf
\n\n# ===== ./frontend.tf =====\n\n
resource "aws_s3_bucket" "frontend" {
  bucket = "${local.name_prefix}-frontend"
}
resource "aws_s3_bucket_website_configuration" "frontend" {
  bucket = aws_s3_bucket.frontend.id
  index_document {
    suffix = "index.html"
  }
}
resource "aws_s3_bucket_public_access_block" "frontend" {
  bucket                  = aws_s3_bucket.frontend.id
  block_public_acls       = false
  block_public_policy     = false
  ignore_public_acls      = false
  restrict_public_buckets = false
}
resource "aws_s3_bucket_policy" "frontend" {
  bucket = aws_s3_bucket.frontend.id
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect    = "Allow"
      Principal = "*"
      Action    = "s3:GetObject"
      Resource  = "${aws_s3_bucket.frontend.arn}/*"
    }]
  })
}
./api_gateway_validation.tf
\n\n# ===== ./api_gateway_validation.tf =====\n\n
resource "aws_apigatewayv2_model" "message_model" {
  api_id       = aws_apigatewayv2_api.http_api.id
  name         = "MessageModel"
  content_type = "application/json"
  schema       = file("${path.module}/schemas/messages.json")
}
# resource "aws_apigatewayv2_route" "post_message" {
#   api_id    = aws_apigatewayv2_api.http_api.id
#   route_key = "POST /messages"
#   target    = "integrations/${aws_apigatewayv2_integration.lambda_integration.id}"

#   request_models = {
#     "application/json" = aws_apigatewayv2_model.message_model.name
#   }
# }
./variables.tf
\n\n# ===== ./variables.tf =====\n\n
variable "aws_region"{ 
    description = "AWS Region"
    type = string
    default = "us-east-1"
}
variable "project_name"{ 
    description = "Project name prefix"
    type = string 
    default = "serverless-smart-inbox-ai"
}
variable "environment"{ 
    description = "Environment name"
    type = string
    default = "dev"
}./lambda.tf
\n\n# ===== ./lambda.tf =====\n\n
resource "aws_lambda_function" "sentiment_processor" {
  function_name    = "${local.name_prefix}-sentiment-processor"
  role             = aws_iam_role.lambda_role.arn
  handler          = "handler.lambda_handler"
  runtime          = "python3.11"
  timeout          = 10
  filename         = "${path.module}/../lambda/lambda.zip"
  source_code_hash = filebase64sha256(("${path.module}/../lambda/lambda.zip"))
  environment {
    variables = {
      #AI Behavior
      NEGATIVE_THRESHOLD = "0.7"
      POSITIVE_THRESHOLD = "0.7"
      LANGUAGE_CODE      = "pt"
      #Routing
      HIGH_QUEUE_URL   = aws_sqs_queue.high_priority.id
      NORMAL_QUEUE_URL = aws_sqs_queue.normal_priority.id
      LOW_QUEUE_URL    = aws_sqs_queue.low_priority
      #Audit
      AUDIT_BUCKET = aws_s3_bucket.audit_bucket.bucket
    }
  }

}
./iam.tf
\n\n# ===== ./iam.tf =====\n\n
resource "aws_iam_role" "lambda_role"{ 
    name = "${local.name_prefix}-lambda-role"
    assume_role_policy = jsonencode({ 
        Version = "2012-10-17"
        Statement = [
            { 
                Effect = "Allow"
                Principal = { 
                    Service = "lambda.amazonaws.com"
                }
                Action = "sts:AssumeRole"
            }
        ]
    })
}
resource "aws_iam_policy" "lambda_policy" { 
    name = "${local.name_prefix}-lambda-policy"

    policy = jsonencode({ 
        Version = "2012-10-17"
        Statement = [ 
            #CloudWatch Logs
            { 
                Effect = "Allow"
                Action = [ 
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                
                ]
                Resource = "arn:aws:logs:*:*:*"
            },
            #Amazon Comprehend
            { 
                Effect = "Allow"
                Action = [ 
                    "comprehend:DetectSentiment"
                ]
                Resource = "*"
            },
            #Amazon SQS (Send only)
            { 
                Effect = "Allow"
                Action = [ 
                    "sqs:sendMessage"
                ]
                Resource = [ 
                    aws_sqs_queue.high_priority.arn,
                    aws_sqs_queue.normal_priority.arn,
                    aws_sqs_queue.low_priority.arn
                ]
            }
        ]
    })
}./s3_audit.tf
\n\n# ===== ./s3_audit.tf =====\n\n
resource "aws_s3_bucket" "audit_bucket" {
  bucket = "${local.name_prefix}-audit"
}
resource "aws_s3_bucket_versioning" "audit_versioning" {
  bucket = aws_s3_bucket.audit_bucket.id
  versioning_configuration {
    status = "Enabled"
  }
}
./sqs.tf
\n\n# ===== ./sqs.tf =====\n\n

resource "aws_sqs_queue" "low_priority" {
  name = "${local.name_prefix}-low-priority"
  redrive_policy = jsonencode(({
    deadLetterTargetArn = aws_sqs_queue.low_priority_dlq.arn
    maxReceiveCount     = 5
  }))
}
resource "aws_sqs_queue" "low_priority_dlq" {
  name = "${local.name_prefix}-low-priority-dlq"
}



resource "aws_sqs_queue" "normal_priority" {
  name = "${local.name_prefix}-normal-priority"
  redrive_policy = jsonencode(({
    deadLetterTargetArn = aws_sqs_queue.normal_priority_dlq.arn
    maxReceiveCount     = 5
  }))
}
resource "aws_sqs_queue" "normal_priority_dlq" {
  name = "${local.name_prefix}-normal-priority-dlq"
}


resource "aws_sqs_queue" "high_priority" {
  name = "${local.name_prefix}-high-priority"
  redrive_policy = jsonencode(({
    deadLetterTargetArn = aws_sqs_queue.high_priority_dlq.arn
    maxReceiveCount     = 5
  }))
}
resource "aws_sqs_queue" "high_priority_dlq" {
  name = "${local.name_prefix}-high-priority-dlq"
}
./api_gateway.tf
\n\n# ===== ./api_gateway.tf =====\n\n
resource "api_gatewayv2_api" "http_api" {
  name          = "${local.name_prefix}-api"
  protocol_type = "HTTP"
}
resource "aws_apigatewayv2_integration" "lambda_integration" {
  api_id                 = aws_apigatewayv2_api.http_api.id
  integration_type       = "AWS_PROXY"
  integration_uri        = aws_lambda_function.sentiment_processor.invoke_arn
  payload_format_version = "2.0"
}
resource "aws_apigatewayv2_route" "post_message" {
  api_id    = aws_apigatewayv2_api.http_api.id
  route_key = "POST /messages"
  target    = "integrations/${aws_apigatewayv2_integration.lambda_integration.id}"

  request_models = {
    "application/json" = aws_apigatewayv2_model.message_model.name
  }
}
resource "aws_apigatewayv2_stage" "default" {
  api_id      = aws_apigatewayv2_api.http_api.id
  name        = "$default"
  auto_deploy = "true"
}
resource "aws_lambda_permissions" "api_gateway" {
  statement_id  = "AllowAPIGatewayInvoke"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.sentiment_processor.function_name
  principal     = "apigateway.amazonaws.com"
  source_arn    = "${aws_apigatewayv2_api.http_api.execution_arn}/*/*"
}
